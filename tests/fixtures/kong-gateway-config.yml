_format_version: "2.1"
_transform: true

services:
  - name: api-gateway-service
    url: http://mock-api:8080
    routes:
      - name: api-route
        paths:
          - /api/v1
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          policy: local
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Forwarded-Proto: https"
              - "X-Real-IP: $(remote_addr)"

  - name: webhook-service
    url: http://mock-webhook:9090
    routes:
      - name: webhook-route
        paths:
          - /webhooks
        methods:
          - POST
        strip_path: false
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          run_on_preflight: true
      - name: webhook
        config:
          method: POST
          url: http://mock-webhook-handler:8081/notify
          headers:
            Content-Type: application/json
            Authorization: Bearer ${WEBHOOK_TOKEN}

  - name: auth-service
    url: http://mock-auth:7070
    routes:
      - name: auth-route
        paths:
          - /auth
        methods:
          - POST
        strip_path: false
    plugins:
      - name: basic-auth
        config: {}
      - name: key-auth
        config:
          key_names:
            - apikey
            - X-API-Key
          hide_credentials: true

consumers:
  - username: test-user
    custom_id: test-user-123
    tags:
      - test
      - development
    keyauth_credentials:
      - key: test-api-key-12345
        tags:
          - test-key
    basicauth_credentials:
      - username: test-user
        password: test-password
        tags:
          - test-auth
    jwt_secrets:
      - algorithm: HS256
        key: test-jwt-secret
        secret: test-jwt-secret-value
        tags:
          - test-jwt

  - username: service-account
    custom_id: service-account-456
    tags:
      - service
      - production
    keyauth_credentials:
      - key: service-api-key-67890
        tags:
          - service-key
    acl_groups:
      - group: admin
      - group: service

upstreams:
  - name: api-upstream
    targets:
      - target: mock-api:8080
        weight: 100
        tags:
          - api
          - primary
    healthchecks:
      active:
        type: http
        http_path: /health
        timeout: 5
        interval: 30
        successes: 2
        failures: 3
      passive:
        type: http
        successes: 2
        failures: 3
    tags:
      - api
      - upstream

  - name: webhook-upstream
    targets:
      - target: mock-webhook:9090
        weight: 100
        tags:
          - webhook
          - primary
    tags:
      - webhook
      - upstream

certificates:
  - cert: |
      -----BEGIN CERTIFICATE-----
      MIICljCCAX4CCQCKPzOWiYlKCTANBgkqhkiG9w0BAQsFADANMQswCQYDVQQGEwJV
      UzAeFw0yMTAxMDEwMDAwMDBaFw0yMjAxMDEwMDAwMDBaMBgxFjAUBgNVBAoMDVRl
      c3QgQ2VydGlmaWNhdGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQD/
      test-certificate-content
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQD/
      test-private-key-content
      -----END PRIVATE KEY-----
    tags:
      - test-cert
      - ssl

plugins:
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true

  - name: request-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true